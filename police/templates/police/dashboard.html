{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
{% load case_filters %}
{% load case_filters_query%}
<style>
    /* Custom styling for a cleaner dashboard look */
    .dashboard-card {
        border-left: 4px solid var(--bs-primary);
        transition: all 0.3s ease;
    }
    .dashboard-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .case-table img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid var(--bs-gray-300);
    }
    .status-pill {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.85em;
    }
    /* Status-specific colors */
    .status-pending { background-color: var(--bs-warning); color: #664d03; }
    .status-verified { background-color: var(--bs-info); color: #055160; }
    .status-closed, .status-resolved { background-color: var(--bs-success); color: #0f5132; }
    
    /* Styles for the surveillance container */
    #videoElement {
        width: 100%; 
        height: auto; 
        border-radius: 0.5rem;
        display: block;
    }
    #detectionCanvas {
        position: absolute;
        top: 0;
        left: 0;
        /* Ensure canvas is always above the video element */
        z-index: 10;
        pointer-events: none; /* Allows clicks to pass through to the video/container */
    }
    .video-feed-wrapper {
        position: relative;
        padding: 0;
        border-radius: 0.5rem;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-light text-secondary"><i class="bi bi-speedometer2 me-2"></i> Police Operations Dashboard</h2>
        <div class="d-flex">
            <a href="{% url 'cases:create' %}" class="btn btn-primary btn-lg shadow-sm me-3">
                <i class="bi bi-plus-circle-fill me-2"></i> Register New Complaint
            </a>
            <button id="startSurveillanceBtn" class="btn btn-danger btn-lg shadow-sm">
                <i class="bi bi-camera-video-fill me-2"></i> Start Live Surveillance
            </button>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6"><div class="card shadow dashboard-card"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><div class="text-secondary fw-bold text-uppercase mb-1">Total Cases</div><div class="h5 mb-0 fw-bold">{{ total_cases|default:0 }}</div></div><i class="bi bi-list-columns-reverse h1 text-primary"></i></div></div></div></div>
        <div class="col-lg-3 col-md-6"><div class="card shadow dashboard-card" style="border-left-color: var(--bs-warning);"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><div class="text-secondary fw-bold text-uppercase mb-1">Pending Verification</div><div class="h5 mb-0 fw-bold text-warning">{{ pending_cases|default:0 }}</div></div><i class="bi bi-hourglass-split h1 text-warning"></i></div></div></div></div>
        <div class="col-lg-3 col-md-6"><div class="card shadow dashboard-card" style="border-left-color: var(--bs-success);"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><div class="text-secondary fw-bold text-uppercase mb-1">Closed/Resolved</div><div class="h5 mb-0 fw-bold text-success">{{ closed_cases|default:0 }}</div></div><i class="bi bi-check2-circle h1 text-success"></i></div></div></div></div>
        <div class="col-lg-3 col-md-6">
            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#notificationModal">
                <div class="card shadow dashboard-card" style="border-left-color: var(--bs-danger);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-secondary fw-bold text-uppercase mb-1">New AI Detections</div>
                                <div class="h5 mb-0 fw-bold text-danger">{{ notifications_count|default:0 }}</div>
                            </div>
                            <i class="bi bi-bell-fill h1 text-danger"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    
    <hr class="my-4">

    <div class="row g-4 mb-5">
        
        <div class="col-lg-7" id="surveillanceContainer" style="display:none;">
            <div class="card shadow-lg">
                <div class="card-header bg-danger text-white fw-bold h4 p-3">
                    <i class="bi bi-webcam me-2"></i> Live Facial Matching Feed
                </div>
                <div class="card-body p-3">
                    <div class="video-feed-wrapper">
                        <video id="videoElement" autoplay playsinline></video>
                        <canvas id="detectionCanvas"></canvas>
                    </div>
                    
                    <div id="detectionStatus" class="alert alert-info mt-3 text-center mb-0">
                        <i class="bi bi-play-circle me-1"></i> Surveillance standby. Press 'Start' to activate.
                    </div>
                    <button id="stopSurveillanceBtn" class="btn btn-sm btn-outline-danger mt-2 w-100">
                        Stop Surveillance
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-12" id="caseListWrapper"> 
            <div class="card shadow-lg">
                <div class="card-header bg-light fw-bold h4 p-3">
                    <i class="bi bi-table me-2"></i> Registered Missing Person Cases
                </div>
                <div class="card-body">
                    
                    <div class="row mb-4 g-3 align-items-center">
                        <div class="col-md-5"><div class="input-group"><span class="input-group-text"><i class="bi bi-search"></i></span><input type="text" id="caseSearchInput" class="form-control" placeholder="Search by name, ID, or location..." onkeyup="filterTable()"></div></div>
                        <div class="col-md-3"><select id="caseSortSelect" class="form-select" onchange="sortCases()"><option value="date_desc">Sort By: Newest First</option><option value="date_asc">Oldest First</option><option value="urgency_desc">Urgency (High First)</option><option value="name_asc">Name (A-Z)</option></select></div>
                        <div class="col-md-3"><select id="caseFilterSelect" class="form-select" onchange="filterTable()"><option value="all">Filter By: All Statuses</option><option value="pending">Pending</option><option value="verified">Verified</option><option value="closed">Closed/Resolved</option></select></div>
                        <div class="col-md-1 text-end"><button class="btn btn-outline-secondary" onclick="clearFilters()"><i class="bi bi-x-circle"></i></button></div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle case-table" id="casesTable">
                            <thead class="table-light"><tr><th>ID</th><th>Photo</th><th>Missing Person</th><th>Gender</th><th>Last Seen Location</th><th>Last Seen Date</th><th>Urgency</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody>
                                {% for case in cases %}
                                <tr data-status="{{ case.status }}" data-urgency="{{ case.urgency }}" data-name="{{ case.missing_name|lower }}" data-location="{{ case.last_seen_location|lower }}">
                                    <td class="fw-bold">{{ case.complaint_id }}</td>
                                    <td>
                                        {% with first_photo=case.photos.all|filter_by_key:"is_detection_evidence=False"|first %}
                                            {% if first_photo and first_photo.image %}
                                                <img src="{{ first_photo.image.url }}" alt="{{ case.missing_name }}" loading="lazy" style="width:50px; height:50px; object-fit:cover; border-radius:8px;">
                                            {% else %}
                                                <img src="{% static 'images/placeholder_person.png' %}" alt="No Photo" loading="lazy" style="width:50px; height:50px; object-fit:cover; border-radius:8px;">
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>{{ case.missing_name }} ({{ case.missing_age|default:'N/A' }})</td>
                                    <td>{{ case.missing_gender|default:'N/A' }}</td>
                                    <td>{{ case.last_seen_location|default:'Unknown' }}</td>
                                    <td>{{ case.last_seen_date|date:"M d, Y"|default:'N/A' }}</td>
                                    <td><span class="badge bg-{{ case.urgency|lower|get_urgency_color }}">{{ case.urgency|upper }}</span></td>
                                    <td><span class="status-pill status-{{ case.status }}">{{ case.status|upper }}</span></td>
                                    <td><a href="{% url 'cases:detail' case.pk %}" class="btn btn-sm btn-outline-info" title="View Details"><i class="bi bi-eye"></i></a></td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="9" class="text-center text-muted p-5"><i class="bi bi-exclamation-circle-fill me-2"></i> No missing person cases have been registered by your department yet.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-body text-center p-5">
        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
        <h3 class="mt-3 fw-bold text-success">Registration Successful!</h3>
        <p class="text-secondary">Your missing person case has been logged.</p>
        
        <h5 class="fw-bold text-dark mt-4">Complaint ID: <span id="modalComplaintId" class="text-primary"></span></h5>
        <small class="text-muted d-block mb-4">Please keep this ID for all inquiries.</small>

        <a href="#" id="printReportLink" class="btn btn-outline-secondary me-2">
            <i class="bi bi-printer me-2"></i> Print Report
        </a>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
            Go to Dashboard <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="notificationModalLabel">
                    <i class="bi bi-bell-fill me-2"></i> AI Detection Alerts ({{ all_detections_list|length }} Total)
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                
                <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                    <p class="mb-0 fw-bold">Unread: <span class="text-danger">{{ notifications_count }}</span></p>
                    <select id="notificationFilter" class="form-select w-auto form-select-sm">
                        <option value="all">Show All</option>
                        <option value="unread" selected>Show Unread Only</option>
                        <option value="read">Show Read Only</option>
                    </select>
                </div>
                
                <div class="list-group list-group-flush" id="notificationList">
                    {% for alert in all_detections_list %}
                        
                        {% with is_unread=alert.alert_sent_at|is_greater_than:request.user.profile.last_dashboard_view %}
                        
                        <div class="list-group-item d-flex align-items-center justify-content-between 
                            {% if is_unread %}bg-warning-subtle unread-item{% else %}read-item{% endif %}" 
                            data-pk="{{ alert.pk }}" 
                            data-is-unread="{{ is_unread|lower }}"> <div class="row align-items-center w-100 me-2">
                                <div class="col-sm-auto">
                                    {% if alert.detection_photo %}
                                    <img 
                                        src="{{ alert.detection_photo.image.url }}" 
                                        alt="Detection Evidence" 
                                        style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #dc3545;"
                                        class="me-3"
                                    >
                                    {% endif %}
                                </div>
                                
                                <div class="col-sm flex-grow-1">
                                    <p class="mb-0 fw-bold text-danger">
                                        MATCH: {{ alert.case.missing_name }} 
                                        <span class="badge bg-danger ms-2">Case ID: {{ alert.case.complaint_id }}</span>
                                    </p>
                                    <p class="mb-0 small text-muted">
                                        Captured at: {{ alert.alert_sent_at|date:"M d, Y H:i:s" }}
                                        {% if alert.detection_photo.latitude and alert.detection_photo.longitude %}
                                            â€” <i class="bi bi-geo-alt-fill"></i> Location Logged
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <div class="btn-group btn-group-sm flex-shrink-0" role="group">
                                
                                <a href="{% url 'cases:detail' alert.case.pk %}" class="btn btn-outline-primary" title="Review Case">
                                    <i class="bi bi-eye"></i>
                                </a>
                                
                                <button type="button" class="btn btn-outline-secondary btn-read" data-pk="{{ alert.pk }}" title="Mark Read">
                                    <i class="bi bi-check2"></i>
                                </button>
                                
                                <button type="button" class="btn btn-outline-danger btn-delete" data-pk="{{ alert.pk }}" title="Delete Notification">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endwith %}
                    {% empty %}
                        <p class="p-4 text-center text-success mb-0">
                            <i class="bi bi-check-circle-fill me-2"></i> No AI detection alerts found.
                        </p>
                    {% endfor %}
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // --- Phase 2, Step 1: Frontend Camera and Streaming Logic ---

    // Correctly defined variables for UI elements
    const startBtn = document.getElementById('startSurveillanceBtn');
    const caseListWrapper = document.getElementById('caseListWrapper');
    const surveillanceContainer = document.getElementById('surveillanceContainer');
    
    // Global state variables
    let stopBtn, videoElement, detectionCanvas, detectionStatus;
    let stream = null;
    let captureInterval = null;
    const FRAME_RATE_MS = 1000;
    let currentLocation = { lat: null, lon: null }; // Global state for location

    // Helper function to dynamically grab elements once the surveillance container is visible
    function getSurveillanceElements() {
        stopBtn = document.getElementById('stopSurveillanceBtn');
        videoElement = document.getElementById('videoElement');
        detectionCanvas = document.getElementById('detectionCanvas');
        detectionStatus = document.getElementById('detectionStatus');
    }

    // --- Geolocation Function (Non-blocking update of global state) ---
    function getGeolocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Success: Update global location state
                    currentLocation.lat = position.coords.latitude;
                    currentLocation.lon = position.coords.longitude;
                }, 
                (error) => {
                    // Failure: Reset location, but DO NOT crash the frame loop
                    console.warn('Geolocation failed:', error.message);
                    currentLocation.lat = null;
                    currentLocation.lon = null;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000, 
                    maximumAge: 60000 
                }
            );
        }
    }

    // Function to start the camera stream
    async function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Your browser does not support camera access.');
            return;
        }

        try {
            // 1. Request video stream
            stream = await navigator.mediaDevices.getUserMedia({ video: {facingMode: "user"} }); 
            
            // 2. Make UI visible and set elements
            surveillanceContainer.style.display = 'block';
            getSurveillanceElements(); // Get elements after they become visible
            
            videoElement.srcObject = stream;
            
            // 3. Adjust layout and disable button
            caseListWrapper.classList.remove('col-lg-12');
            caseListWrapper.classList.add('col-lg-5');
            startBtn.disabled = true;

            // 4. Wait for video metadata to load
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                resizeCanvas(); 
                
                // Set initial status to active and update UI
                detectionStatus.className = 'alert alert-info mt-3 text-center mb-0';
                detectionStatus.innerHTML = '<i class="bi bi-search me-1"></i> Surveillance active. Searching for matches...';
                
                // 5. CRITICAL: Start location fetch immediately (resolves Violation)
                getGeolocation(); 
                
                // 6. Start frame sending
                startCaptureInterval(); 
            };
            
        } catch (err) {
            console.error('Error accessing camera:', err);
            startBtn.disabled = false; 
            surveillanceContainer.style.display = 'none';

            alert('Error accessing camera: Please ensure camera permissions are granted and no other application is using it.');
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        clearInterval(captureInterval);
        captureInterval = null;
        
        // Reset UI state
        videoElement.pause();
        surveillanceContainer.style.display = 'none';
        caseListWrapper.classList.remove('col-lg-5');
        caseListWrapper.classList.add('col-lg-12');
        startBtn.disabled = false;
        
        // Clear canvas drawings
        const ctx = detectionCanvas.getContext('2d');
        ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
    }

    function resizeCanvas() {
        if (!videoElement || !detectionCanvas) return;

        detectionCanvas.width = videoElement.videoWidth;
        detectionCanvas.height = videoElement.videoHeight;
        
        detectionCanvas.style.width = videoElement.clientWidth + 'px';
        detectionCanvas.style.height = videoElement.clientHeight + 'px';
    }

    function startCaptureInterval() {
        // We rely on getGeolocation being called on startCamera and inside sendFrameToBackend
        captureInterval = setInterval(sendFrameToBackend, FRAME_RATE_MS);
    }

    // Function to capture a frame and send it to the Django API endpoint
    function sendFrameToBackend() {
        if (!stream || !videoElement || videoElement.paused || videoElement.ended) return;

        // 1. Capture frame
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

        // 2. Update Geolocation (non-blocking) just before sending
        getGeolocation();

        const frameData = canvas.toDataURL('image/jpeg', 0.8);

        // 3. Send via AJAX
        fetch("{% url 'police:surveillance_match' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                image: frameData,
                location: currentLocation // Send the coordinates (will be null if permission denied)
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            handleDetectionResult(data);
        })
        .catch(error => {
            console.error('API Error:', error);
            detectionStatus.className = 'alert alert-danger mt-3 text-center mb-0';
            detectionStatus.innerHTML = `<i class="bi bi-cloud-slash me-1"></i> API connection error. Check console.`;
        });
    }
    
    function handleDetectionResult(data) {
        const ctx = detectionCanvas.getContext('2d');
        
        resizeCanvas(); 
        ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);

        if (data.status === 'match_found' && data.detections && data.detections.length > 0) {
            detectionStatus.className = 'alert alert-success mt-3 text-center mb-0';
            detectionStatus.innerHTML = `<i class="bi bi-exclamation-octagon-fill me-1"></i> **MATCH FOUND!**`;

            data.detections.forEach(detection => {
                const [nx, ny, nw, nh] = detection.box; 

                const videoW = detectionCanvas.width;
                const videoH = detectionCanvas.height;

                const x = nx * videoW;
                const y = ny * videoH;
                const w = nw * videoW;
                const h = nh * videoH;
                
                const caseId = detection.case_id;
                const similarity = detection.similarity;

                // --- Draw Bounding Box ---
                ctx.strokeStyle = '#dc3545'; // Red
                ctx.lineWidth = 4;
                ctx.strokeRect(x, y, w, h);

                // --- Draw Label Background ---
                ctx.fillStyle = '#dc3545';
                ctx.fillRect(x, y - 35, 300, 35);

                // --- Draw Label Text ---
                ctx.fillStyle = 'white';
                ctx.font = '24px sans-serif';
                ctx.fillText(`MATCH: ${caseId} (${(similarity * 100).toFixed(1)}%)`, x + 5, y - 10);
            });
            
        } else {
            detectionStatus.className = 'alert alert-info mt-3 text-center mb-0';
            detectionStatus.innerHTML = '<i class="bi bi-search me-1"></i> Surveillance active. Searching for matches...';
        }
    }

    // Helper function to get the CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function resizeCanvas() {
        if (!videoElement || !detectionCanvas) return;
        detectionCanvas.width = videoElement.videoWidth;
        detectionCanvas.height = videoElement.videoHeight;
        detectionCanvas.style.width = videoElement.clientWidth + 'px';
        detectionCanvas.style.height = videoElement.clientHeight + 'px';
    }
    
    // --- Event Listener Initialization (Only run once on page load) ---
    document.addEventListener('DOMContentLoaded', () => {
        startBtn.addEventListener('click', startCamera);
        
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'stopSurveillanceBtn') {
                stopCamera();
            }
        });
        window.addEventListener('resize', resizeCanvas); 
        sortCases(); // Initial table sort

        // Handle post-registration success modal display here
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.get('success');
        const complaintId = urlParams.get('id');

        if (isSuccess === 'true' && complaintId) {
            const modalElement = document.getElementById('successModal');
            document.getElementById('modalComplaintId').textContent = complaintId;
            
            document.getElementById('printReportLink').addEventListener('click', (e) => {
                e.preventDefault();
                window.print();
            });

            const successModal = new bootstrap.Modal(modalElement);
            successModal.show();
            
            window.history.replaceState(null, null, window.location.pathname);
        }
    });

// Notification Logic
    document.addEventListener('DOMContentLoaded', function() {
        // --- Setup Variables ---
        const filterSelect = document.getElementById('notificationFilter');
        const notificationList = document.getElementById('notificationList');
        const unreadCountSpan = document.querySelector('.mb-0 .text-danger');
        
        // --- Helper Function to Update KPI Count ---
        function updateKpiCount() {
            if (!unreadCountSpan) return;
            const currentCount = notificationList.querySelectorAll('.unread-item').length;
            unreadCountSpan.textContent = currentCount;
        }

        // --- 1. FILTER LOGIC ---
        const applyFilter = function() {
            const selectedValue = filterSelect.value;
            const items = notificationList.querySelectorAll('.list-group-item');

            items.forEach(item => {
                // Read the string value: 'true' or 'false'
                const isUnread = item.getAttribute('data-is-unread'); 
                
                if (selectedValue === 'all') {
                    item.style.display = 'flex';
                } else if (selectedValue === 'unread') {
                    item.style.display = (isUnread === 'true') ? 'flex' : 'none';
                } else if (selectedValue === 'read') {
                    item.style.display = (isUnread === 'false') ? 'flex' : 'none';
                }
            });
        };
        
        if (filterSelect) {
            filterSelect.addEventListener('change', applyFilter);
            // Apply initial filter (Show Unread Only, since it's selected="true")
            applyFilter(); 
        }

        // --- 2. ACTION LOGIC (Read and Delete) ---
        if (notificationList) {
            notificationList.addEventListener('click', function(e) {
                const target = e.target;
                let action = null;
                let button = null;
                
                // Determine action type and button element
                if (target.closest('.btn-delete')) {
                    action = 'delete';
                    button = target.closest('.btn-delete');
                } else if (target.closest('.btn-read')) {
                    action = 'read';
                    button = target.closest('.btn-read');
                }

                if (action && button) {
                    const alertPk = button.getAttribute('data-pk'); 

                    if (action === 'delete' && !confirm("Are you sure you want to permanently delete this alert? (Evidence photo remains)")) {
                        return; 
                    }

                    fetch("{% url 'police:notification_action' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: new URLSearchParams({
                            'action': action,
                            'alert_pk': alertPk 
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const item = button.closest('.list-group-item');
                            
                            if (action === 'delete') {
                                // 1. Visually remove the item
                                item.remove();
                                // 2. Update the count
                                updateKpiCount(); 
                            } else if (action === 'read') {
                                // 1. Update visual status
                                item.classList.remove('bg-warning-subtle', 'unread-item');
                                item.classList.add('read-item');
                                // 2. Update data attribute for filtering
                                item.setAttribute('data-is-unread', 'false');
                                // 3. Update the count
                                updateKpiCount();
                                // 4. Re-apply filter to hide the item if 'unread' filter is selected
                                applyFilter(); 
                            }
                        } else {
                            alert(`Error during ${action}: ` + data.message);
                        }
                    })
                    .catch(error => console.error('Action error:', error));
                }
            });
        }
        
        // Initial KPI Count update on load (in case user opened the modal on a previous visit)
        updateKpiCount();
    });
</script>
{% endblock %}

